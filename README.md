# MockUp Bank Infra (AWS Version)

Supplementary Terraform code for the [MockUp Bank porject](https://h0c0b.github.io/posts/Intro/) that sets up a multi-account and multi-region infrastructure in AWS that will host the backend, and devsecops tooling.

This work is based on Oliver Schenk's article and code posted here
[AWS Multi-account Multi-region Bootstrapping with Terraform](https://medium.com/@oliver.schenk/aws-multi-account-multi-region-bootstrapping-with-terraform-39aeed097ad2)

## Warning Regarding Costs

The resources deployed in this project includes a number of accounts and features, such as EKS, RDS and EC2 instances, will incure significant expences if run for an extensive ammount of time!
The destruction of some of the pieces of infrastucture will require manual intervention! Make sure you understand

> **Your costs are your responsibility.**

## Architecture

The aim of this project is to bootstrap a foundational multi-account structure compliant with AWS Well Architected Framework . Pretty much similar to what AWS Control Tower creates. This includes AWS Organizations, five member accounts and the basic roles needed to manage Terraform state and deploy resources into member accounts.

The AWS Organization that is created has the following OU structure and member accounts.

- **Root OU**
  - Management Account
  - **Deployment OU**
    - Deployment Account
  - **Infrastructure OU**
    - Shared Services Account
  - **Sandbox OU**
    - Development Account
  - **Security OU**
    - Logging Account
    - Security Account
  - **Workloads OU**
    - **Prod OU**
    - **Test OU**

The OUs structure shown can be customised to your own needs in the `bootstrap/organization/main.tf` Terraform source if you have different requirements. The basic purpose of each is listed below.

- **Deployment OU** - OU that hosts another special account that hosts TF state as well as roles and IAM provider for GitHub Actions.
- **Infrastructure OU** - OU that hosts accounts reserved for self-hosted infa/devops-ish stuff like Keycloak, Jenkins and etc.
- **Sandbox OU** - OU that hosts Accounts for developers either randomly allocated or one per developer go here. This project just adds one generic account.
- **Security OU** - OU that hosts security related accounts including logging accounts and security tools.
- **Workloads OU** - This is where our production application and customer facing workloads go.

You can customise this project according to your own needs.

## Project Structure

### Root folder and src/common_vars.yaml

Set your values for namespace, names, account email addresses, notification settings, etc in the  `common_vars.yaml` file.
This is where the core terragrunt.hcl file lives which defines the providers and backend configs.

> Note that terragrunt automatically creates the backend S3 bucket and dynamo table for you! Don't create them manually as you'll have to impoort them into the TF state.

### /bootstrap

This contains the code for the first phase of the deployment, which is setting up the AWS Organization, OUs and member accounts. This also includes initial Terraform state and Terraform deployment cross-account roles.

The resources in this folder should only be the bare minimum required that can't be deployed by the Deployment acccount. All other resources should be defined in the `/live_infra` folder under the relevant region and account.

### /live_infra

This contains the code for deploying resources related to each individual account and region. Most of the accounts are empty, as they are just for demonstration of the structure.

### /accounts.json

The accounts.json file is generated by the `make accounts_list` after the bootstrapping process has finished. It is used by the Terraform and Terragrunt code to obtain account IDs where needed.

> Don't forget to updaate this file from time to time. Although manual editing is not encouraged it's still possible

### /modules

This is where all your re-usable Terraform modules/templates go.

## How to Use

## Auto

**Note on IAM during the bootstraping proccess. Unlike the original code by Oliver Schenk's this interpretation uses the AWS IAM Identity Center. In my particular case it was already set up in the management account by the AWS Control Tower. This IaC doesn't do it for you at the moment. You'll have to configure it manually together with your users and relevant roles, or revert to the original repo**
[TBD]

### Incorporating the Existing 
